variant: fcos
version: 1.4.0
passwd:
  users:
    - name: kp9001
      ssh_authorized_keys:
        - sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIC1UQ0EQoa05ZkMHBEm++bIRTfWHf3M+XYzGrGMplqUhAAAAC3NzaDp0ZXJtaXVz Generated By Termius
        - sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIPVSoRjKO3rnrh1+u/K9yxg3g1pFMc+H2g49aVloBgiMAAAAC3NzaDp0ZXJtaXVz Generated By Termius
        - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMi4zESvbZnVo7gT8UsSNzGLW6ItK+8w1mOpr/xtvaeJNuaCHMfuFnU5JA1fbqvTw3cLm0XbgYgpoLscxoEPG8s=
      groups:
        - docker
        - sudo
systemd:
  units:
    - name: postinst.service
      enabled: true
      contents: |
        [Unit]
        Description=Initial System Setup
        After=systemd-machine-id-commit.service
        After=network-online.target
        Before=zincati.service
        ConditionPathExists=!/var/lib/%N.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/sed -i 's/#DNS=/DNSSEC=1.1.1.1/g' /etc/systemd/resolved.conf
        ExecStart=/usr/bin/sed -i 's/#FallbackDNS=/FallbackDNS=1.0.0.1/g' /etc/systemd/resolved.conf
        ExecStart=/usr/bin/sed -i 's/#DNSSEC=no/DNSSEC=yes/g' /etc/systemd/resolved.conf
        ExecStart=/usr/bin/systemctl restart systemd-resolved
        ExecStart=/usr/bin/rpm-ostree install docker-compose firewalld qemu-guest-agent tuned unbound vim tmux parted
        ExecStart=/usr/bin/rpm-ostree override remove cifs-utils samba-common-libs samba-client-libs libsmbclient libwbclient samba-common sssd-krb5-common sssd-ipa sssd-nfs-idmap sssd-ldap sssd-client sssd-ad sssd-common sssd-krb5 sssd-common-pac
        ExecStart=/usr/bin/sed -i 's/nullok//g' /etc/pam.d/system-auth
        ExecStart=/usr/bin/mkdir -p /etc/ssh/sshd_config.d
        ExecStart=/usr/bin/mkdir -p /etc/systemd/system/NetworkManager.service.d
        ExecStart=/usr/bin/mkdir -p /etc/systemd/system/irqbalance.service.d
        ExecStart=/usr/bin/mkdir -p /etc/systemd/system/unbound.service.d
        ExecStart=/usr/bin/mkdir -p /etc/security/limits.d
        ExecStart=/usr/bin/mkdir -p /etc/nginx/conf.d
        ExecStart=/usr/bin/mkdir -p /etc/unbound
        ExecStart=/usr/bin/mkdir -p /etc/tuned
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/ssh/sshd_config.d/10-custom.conf -o /etc/ssh/sshd_config.d/10-custom.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/modprobe.d/30_security-misc.conf -o /etc/modprobe.d/30_security-misc.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/sysctl.d/30_security-misc.conf -o /etc/sysctl.d/30_security-misc.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/sysctl.d/30_silent-kernel-printk.conf -o /etc/sysctl.d/30_silent-kernel-printk.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/sysctl.d/30_security-misc_kexec-disable.conf -o /etc/sysctl.d/30_security-misc_kexec-disable.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/chrony.conf -o /etc/chrony.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/security/limits.d/30-disable-coredump.conf -o /etc/security/limits.d/30-disable-coredump.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/systemd/zram-generator.conf -o /etc/systemd/zram-generator.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/systemd/system/NetworkManager.service.d/99-brace.conf -o /etc/systemd/system/NetworkManager.service.d/99-brace.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/systemd/system/irqbalance.service.d/99-brace.conf -o /etc/systemd/system/irqbalance.service.d/99-brace.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/nginx/conf.d/matrix.conf -o /etc/nginx/conf.d/matrix.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/systemd/system/unbound.service.d/override.conf -o /etc/systemd/system/unbound.service.d/override.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/unbound/unbound.conf -o /etc/unbound/unbound.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/tuned/active_profile -o /etc/tuned/active_profile
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/tuned/profile_mode -o /etc/tuned/profile_mode
        ExecStart=/bin/systemctl disable systemd-resolved
        ExecStart=/bin/touch /var/lib/%N.stamp
        ExecStart=/bin/systemctl --no-block reboot

        [Install]
        WantedBy=multi-user.target
    - name: postinst2.service
      enabled: true
      contents: |
        [Unit]
        Description=Initial System Setup 2
        After=network-online.target
        ConditionPathExists=!/var/lib/%N.stamp
        ConditionPathExists=/var/lib/postinst.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/docker run --detach --privileged --name watchtower --restart unless-stopped --runtime=runc -v /var/run/docker.sock:/var/run/docker.sock -v /etc/localtime:/etc/localtime:ro containrrr/watchtower --schedule "* 15 8 * * *"
        ExecStart=/bin/touch /var/lib/%N.stamp

        [Install]
        WantedBy=multi-user.target
    - name: setsebool.service
      enabled: true
      contents: |
        [Service]
        Type=oneshot
        ExecStart=/usr/sbin/setsebool container_use_cephfs off
        ExecStart=/usr/sbin/setsebool virt_use_nfs off
        ExecStart=/usr/sbin/setsebool virt_use_samba off
        RemainAfterExit=yes
        [Install]
        WantedBy=multi-user.target
    - name: postboot.service
      enabled: true
      contents: |
        [Unit]
        Description=Update system configuration on boot
        Requires=network-online.target
        After=network-online.target
        ConditionPathExists=!/var/lib/postboot-lock.stamp
        ConditionPathExists=/var/lib/postinst.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/sleep 5
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/ssh/sshd_config.d/10-custom.conf -o /etc/ssh/sshd_config.d/10-custom.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/modprobe.d/30_security-misc.conf -o /etc/modprobe.d/30_security-misc.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/sysctl.d/30_security-misc.conf -o /etc/sysctl.d/30_security-misc.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/sysctl.d/30_silent-kernel-printk.conf -o /etc/sysctl.d/30_silent-kernel-printk.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/sysctl.d/30_security-misc_kexec-disable.conf -o /etc/sysctl.d/30_security-misc_kexec-disable.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/chrony.conf -o /etc/chrony.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/security/limits.d/30-disable-coredump.conf -o /etc/security/limits.d/30-disable-coredump.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/systemd/zram-generator.conf -o /etc/systemd/zram-generator.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/systemd/system/NetworkManager.service.d/99-brace.conf -o /etc/systemd/system/NetworkManager.service.d/99-brace.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/systemd/system/irqbalance.service.d/99-brace.conf -o /etc/systemd/system/irqbalance.service.d/99-brace.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/systemd/system/unbound.service.d/override.conf -o /etc/systemd/system/unbound.service.d/override.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/unbound/unbound.conf -o /etc/unbound/unbound.conf
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/tuned/active_profile -o /etc/tuned/active_profile
        ExecStart=/usr/bin/curl https://raw.githubusercontent.com/kp9001/server-architecture/main/etc/tuned/profile_mode -o /etc/tuned/profile_mode
        ExecStart=/usr/bin/systemctl daemon-reload

        [Install]
        WantedBy=multi-user.target
    - name: gvisor-updater.service
      enabled: true
      contents: |
        [Unit]
        Description=gVisor Update
        Requires=network-online.target
        After=network-online.target
        Before=docker.service

        [Service]
        WorkingDirectory=/var/roothome
        Type=oneshot
        ExecStart=/usr/bin/sleep 5
        ExecStart=/usr/bin/curl -O https://storage.googleapis.com/gvisor/releases/release/latest/x86_64/runsc
        ExecStart=/usr/bin/curl -O https://storage.googleapis.com/gvisor/releases/release/latest/x86_64/runsc.sha512
        ExecStart=/usr/bin/curl -O https://storage.googleapis.com/gvisor/releases/release/latest/x86_64/containerd-shim-runsc-v1
        ExecStart=/usr/bin/curl -O https://storage.googleapis.com/gvisor/releases/release/latest/x86_64/containerd-shim-runsc-v1.sha512
        ExecStart=/usr/bin/sha512sum -c runsc.sha512 -c containerd-shim-runsc-v1.sha512
        ExecStart=/usr/bin/rm -f runsc.sha512 containerd-shim-runsc-v1.sha512
        ExecStart=/usr/bin/chmod a+rx runsc containerd-shim-runsc-v1
        ExecStart=/usr/bin/mv runsc containerd-shim-runsc-v1 /var/usrlocal/bin
        ExecStart=/usr/bin/chcon system_u:object_r:container_runtime_exec_t:s0 /var/usrlocal/bin/runsc

        [Install]
        WantedBy=multi-user.target
    - name: docker.service
      enabled: true
    - name: fstrim.timer
      enabled: true
    - name: systemd-oomd.service
      enabled: true
    - name: rpm-ostree-countme.timer
      enabled: false
      mask: true
storage:
  files:
    - path: /etc/zincati/config.d/51-rollout-wariness.toml
      contents:
        inline: |
          [identity]
          rollout_wariness = 0
    - path: /etc/zincati/config.d/55-updates-strategy.toml
      contents:
        inline: |
          [updates]
          strategy = "periodic"
          [updates.periodic]
          time_zone = "localtime"
          [[updates.periodic.window]]
          days = [ "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun" ]
          start_time = "8:00"
          length_minutes = 60
    - path: /etc/docker/daemon.json
      contents:
        inline: |
          {
              "default-runtime": "runsc-systrap",
              "runtimes": {
                  "runsc-systrap": {
                      "path": "/var/usrlocal/bin/runsc",
                      "runtimeArgs": [
                          "--platform=systrap",
                          "--network=host"
                      ]
                  },
                  "runsc-ptrace": {
                      "path": "/var/usrlocal/bin/runsc",
                      "runtimeArgs": [
                          "--platform=ptrace",
                          "--network=host"
                      ]
                  },
                  "runsc-kvm": {
                      "path": "/var/usrlocal/bin/runsc",
                      "runtimeArgs": [
                          "--platform=kvm",
                          "--network=host"
                      ]
                  }
              }
          }
  links:
    - path: /etc/localtime
      target: ../usr/share/zoneinfo/UTC
    - path: /etc/systemd/system/multi-user.target.wants/unbound.service
      target: /usr/lib/systemd/system/unbound.service
    - path: /etc/systemd/system/multi-user.target.wants/tuned.service
      target: /usr/lib/systemd/system/tuned.service
    - path: /etc/systemd/system/kdump.service.target
      target: /dev/null
kernel_arguments:
  should_exist:
    - spectre_v2=on
    - spec_store_bypass_disable=on
    - l1tf=full,force
    - mds=full,nosmt
    - tsx=off
    - tsx_async_abort=full,nosmt
    - kvm.nx_huge_pages=force
    - nosmt=force
    - l1d_flush=on
    - mmio_stale_data=full,nosmt
    - random.trust_bootloader=off
    - random.trust_cpu=off
    - intel_iommu=on
    - amd_iommu=on
    - iommu.passthrough=0 iommu.strict=1
    - slab_nomerge
    - init_on_alloc=1
    - init_on_free=1
    - pti=on
    - vsyscall=none
    - page_alloc.shuffle=1
    - randomize_kstack_offset=on
    - extra_latent_entropy
    - debugfs=off
